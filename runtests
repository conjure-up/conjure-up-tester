#!/bin/bash

set -eux

# Override cloud to test
: "${CLOUD:=localhost}"

# Snap channel
: "${CHANNEL:=edge}"

export PATH=/snap/bin:$PATH
export CLOUD=$CLOUD
export DEBIAN_FRONTEND=noninteractive
export CONJUREUP_REGISTRY_BRANCH=master
export CONJUREUP_BASEDIR=/home/ubuntu/conjure-up

# annotate each output line with timestamp
annotate() {
    set -o pipefail
    eval "$*" 2>&1 | awk '{ print strftime("%Y-%m-%d %H:%M:%S"), $0; fflush(); }'
}

function run_tox {
    git clone https://github.com/conjure-up/conjure-up-tests $CONJUREUP_BASEDIR
    cd "$CONJUREUP_BASEDIR" && tox -e py35,flake,isort
    cd "$CONJUREUP_BASEDIR" && tox -e conjure-dev
}

function run {
    lxd init --auto || true
    lxc network create lxdbr0 ipv4.address=auto ipv4.nat=true ipv6.address=none ipv6.nat=false || true

    local spells=(kubernetes \
                      openstack
                 )

    echo "Running spell tests"
    for spell in "${spells[@]}"; do
        sudo -E su "$USER" -c "source $CONJUREUP_BASEDIR/conjure-dev/bin/activate && conjure-up -c $CONJUREUP_BASEDIR/deployments/Conjurefile -c $CONJUREUP_BASEDIR/deployments/Conjurefile.$CLOUD.$spell"
        juju destroy-model -y test-model
    done
    exit 0
}

juju destroy-model -y test-model || true
annotate run_tox
annotate run
